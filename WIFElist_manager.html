<html><head>
    <title>WIFElist - Participant Management System</title>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
        background-color: white;
        margin: 20px auto !important;
        padding: 1rem !important;
        border-radius: 8px;
        width: 95% !important;
        max-width: 800px !important;
        position: relative;
    }
    #archivedModal .modal-content {
      width: 95% !important;
      max-width: none !important;
    }
    .modal-content form {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
    .modal-content form .col-span-2 {
      grid-column: span 2;
    }
    .modal-content form label {
      font-weight: 500;
      color: #4a5568;
    }
    .modal-content form input,
    .modal-content form select,
    .modal-content form textarea {
      padding: 0.5rem;
      border: 1px solid #e2e8f0;
      border-radius: 0.375rem;
      width: 100%;
    }
    .modal-content form .space-y-4 {
      margin-top: 1rem;
    }
    .modal-content h2 {
      margin-bottom: 1rem !important;
    }
    .expanded-info {
        display: none;
        background-color: #f8f9fa;
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
    }
    .table-container {
        max-height: 70vh;
        overflow-y: auto;
    }
    .sortable:hover {
        cursor: pointer;
        background-color: #f0f0f0;
    }
    .thumbnail {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 4px;
    }
    .wallet-info {
      display: none;
      background-color: #f8f9fa;
      padding: 10px;
      margin: 5px 0;
      border-radius: 4px;
      width: 100%;
      max-width: 800px;
    }
    
    .copy-button {
      padding: 2px 6px;
      font-size: 12px;
      background: #e2e8f0;
      border-radius: 4px;
      margin-left: 8px;
      cursor: pointer;
    }
    
    .copy-button:hover {
      background: #cbd5e0;
    }
    .modal-close-button {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        background: #f3f4f6;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .modal-close-button:hover {
        background: #e5e7eb;
    }
    .container {
      max-width: 95% !important;
    }
    
    .modal-content {
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      top: 20px;
    }
    
    #archivedModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    
    .archived-table-container {
      max-height: 70vh;
      overflow-y: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
    }
    
    .image-preview {
      width: 100px;
      height: 100px;
      object-fit: cover;
      margin: 10px 0;
    }
    
    .search-container {
      position: relative;
      width: 300px;
    }
    
    .search-result {
      padding: 0.5rem;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    
    .search-result:hover {
      background: #f3f4f6;
    }
    
    .archived-tag {
      background: #cbd5e0;
      color: #4a5568;
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      margin-left: 0.5rem;
    }
    
    .wallet-chain-section {
      margin-bottom: 1rem;
    }
    
    .wallet-address-row {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
      font-family: monospace;
      word-break: break-all;
    }
    
    .wallet-address-row .copy-button {
      flex-shrink: 0;
      margin-left: 0.5rem;
    }
    </style>
    </head>
    <body class="bg-gray-100 p-4">
        <div class="container mx-auto bg-white rounded-lg shadow p-6">
            <h1 class="text-2xl font-bold mb-4">WIFElist Management System</h1>
            
            <!-- Control Panel -->
            <div class="flex flex-wrap gap-4 mb-6">
                <button onclick="showAddModal()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    <i class="fas fa-plus mr-2"></i>Add Entry
                </button>
                <button onclick="importXLSX()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    <i class="fas fa-file-import mr-2"></i>Import XLSX
                </button>
                <button onclick="showExportModal()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    <i class="fas fa-file-export mr-2"></i>Export
                </button>
                <div class="relative">
                  <input type="text" id="searchInput" oninput="searchParticipants()" placeholder="Search entries..." class="w-full px-4 py-2 border rounded-lg">
                  <div id="searchResults" class="absolute z-10 w-full mt-1 bg-white border rounded-lg shadow-lg hidden max-h-60 overflow-y-auto"></div>
                </div>
                <button onclick="toggleFilters()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    <i class="fas fa-filter mr-2"></i>Filters
                </button>
                <button onclick="showArchivedEntries()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    <i class="fas fa-archive mr-2"></i>Archived Entries
                </button>
            </div>
    
            <!-- Filter Panel (Initially Hidden) -->
            <div id="filterPanel" class="hidden mb-4 p-4 bg-gray-50 rounded">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Status</label>
                        <select id="statusFilter" class="mt-1 block w-full rounded border-gray-300">
                            <option value>All</option>
                            <option value="Winner">Winner</option>
                            <option value="Pending">Pending</option>
                            <option value="Archived">Archived</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Date Range</label>
                        <input type="text" id="dateFilter" class="mt-1 block w-full rounded border-gray-300" placeholder="Select date range">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Platform</label>
                        <select id="platformFilter" class="mt-1 block w-full rounded border-gray-300">
                            <option value>All</option>
                            <option value="Telegram">Telegram</option>
                            <option value="X">X (Twitter)</option>
                            <option value="Discord">Discord</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Chain Address</label>
                        <div class="flex gap-2">
                            <input type="checkbox" id="solanaFilter" class="mr-2">
                            <label for="solanaFilter">Solana</label>
                            <input type="checkbox" id="baseFilter" class="mr-2">
                            <label for="baseFilter">Base</label>
                            <input type="checkbox" id="polygonFilter" class="mr-2">
                            <label for="polygonFilter">Polygon</label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Content</label>
                        <div class="flex gap-2">
                            <input type="checkbox" id="hasImageFilter" class="mr-2">
                            <label for="hasImageFilter">Has Image</label>
                            <input type="checkbox" id="hasInfoFilter" class="mr-2">
                            <label for="hasInfoFilter">Has Info</label>
                        </div>
                    </div>
                </div>
                <button onclick="applyFilters()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Apply Filters
                </button>
                <button onclick="clearFilters()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    Clear Filters
                </button>
            </div>
    
            <!-- Table Container -->
            <div class="table-container">
                <table class="min-w-full table-auto">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="px-4 py-2">#</th>
                            <th class="sortable px-4 py-2" onclick="sortTable(1)">Name</th>
                            <th class="sortable px-4 py-2" onclick="sortTable(2)">Status</th>
                            <th class="px-4 py-2">Telegram</th>
                            <th class="px-4 py-2">X (Twitter)</th>
                            <th class="px-4 py-2">Discord</th>
                            <th class="px-4 py-2">Email</th>
                            <th class="px-4 py-2">Info</th>
                            <th class="px-4 py-2">Image</th>
                            <th class="sortable px-4 py-2" onclick="sortTable(9)">Date</th>
                            <th class="px-4 py-2">
                              <div class="flex items-center">
                                <div class="flex flex-col items-center mr-2">
                                  <i class="fas fa-wallet text-orange-500 text-xs"></i>
                                  <span id="walletCount" class="text-xs font-normal"></span>
                                </div>
                                Actions
                              </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="participantTableBody">
                        <!-- Table content will be dynamically populated -->
                    </tbody>
                </table>
            </div>
            <div class="flex items-center justify-between mt-4">
              <div class="flex items-center">
                <span id="pageInfo">Page 1 of 1</span>
              </div>
              <div>
                <button id="prevPage" class="bg-gray-200 px-4 py-2 rounded mr-2">&lt;</button>
                <button id="nextPage" class="bg-gray-200 px-4 py-2 rounded">&gt;</button>
              </div>
            </div>
        </div>
    
        <!-- Add/Edit Modal -->
        <div id="entryModal" class="modal">
            <div class="modal-content">
                <button onclick="closeModal()" class="modal-close-button">
                    <i class="fas fa-times"></i>
                </button>
                <h2 id="modalTitle" class="text-xl font-bold mb-4">Add New Entry</h2>
                <form id="entryForm" class="space-y-4">
                    <input type="hidden" id="editId">
                    <div class="grid grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="text" id="entryDate" class="mt-1 block w-full rounded border-gray-300">
                      </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Name</label>
                            <input type="text" id="participantName" class="mt-1 block w-full rounded border-gray-300" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Status</label>
                            <select id="status" class="mt-1 block w-full rounded border-gray-300">
                                <option value="Winner">Winner</option>
                                <option value="Pending">Pending</option>
                                <option value="Manual">Manual</option>
                                <option value="Finished">Finished</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Telegram</label>
                            <input type="text" id="telegram" class="mt-1 block w-full rounded border-gray-300">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">X (Twitter)</label>
                            <input type="text" id="twitter" class="mt-1 block w-full rounded border-gray-300">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Discord</label>
                            <input type="text" id="discord" class="mt-1 block w-full rounded border-gray-300">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="email" class="mt-1 block w-full rounded border-gray-300">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Info</label>
                            <textarea id="info" class="mt-1 block w-full rounded border-gray-300" rows="3"></textarea>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Image</label>
                            <input type="file" id="imageUpload" accept="image/*" class="mt-1 block w-full">
                            <input type="text" id="imageUrl" class="mt-1 block w-full rounded border-gray-300" placeholder="Or enter image URL">
                        </div>
                    </div>
                    <div class="col-span-2">
                      <label class="block text-sm font-medium text-gray-700">Wallet Addresses</label>
                      <div class="space-y-4">
                        <div>
                          <label class="text-sm text-gray-600">Solana Addresses</label>
                          <div id="solanaAddressContainer">
                            <div class="flex gap-2 mb-2">
                              <input type="text" class="solanaAddress mt-1 block w-full rounded border-gray-300">
                              <button type="button" onclick="addAddressField(&apos;solana&apos;)" class="bg-blue-500 text-white px-2 rounded">+</button>
                            </div>
                          </div>
                        </div>
                        <div>
                          <label class="text-sm text-gray-600">Base Chain Addresses</label> 
                          <div id="baseAddressContainer">
                            <div class="flex gap-2 mb-2">
                              <input type="text" class="baseAddress mt-1 block w-full rounded border-gray-300">
                              <button type="button" onclick="addAddressField(&apos;base&apos;)" class="bg-blue-500 text-white px-2 rounded">+</button>
                            </div>
                          </div>
                        </div>
                        <div>
                          <label class="text-sm text-gray-600">Polygon Addresses</label>
                          <div id="polygonAddressContainer">
                            <div class="flex gap-2 mb-2">
                              <input type="text" class="polygonAddress mt-1 block w-full rounded border-gray-300">
                              <button type="button" onclick="addAddressField(&apos;polygon&apos;)" class="bg-blue-500 text-white px-2 rounded">+</button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                      <button type="submit" form="entryForm" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Save
                      </button>
                      <button type="button" onclick="closeModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                      </button>
                    </div>
                </form>
            </div>
        </div>
    
        <!-- Archived Entries Modal -->
        <div id="archivedModal" class="modal">
          <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-xl font-bold">Archived Entries</h2>
              <button onclick="document.getElementById('archivedModal').style.display='none'" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full bg-white">
                <thead>
                  <tr>
                    <th class="px-4 py-2">#</th>
                    <th class="px-4 py-2">ID</th>
                    <th class="px-4 py-2">Name</th>
                    <th class="px-4 py-2">Status</th>
                    <th class="px-4 py-2">Telegram</th>
                    <th class="px-4 py-2">Twitter</th>
                    <th class="px-4 py-2">Discord</th>
                    <th class="px-4 py-2">Email</th>
                    <th class="px-4 py-2">Info</th>
                    <th class="px-4 py-2">Image</th>
                    <th class="px-4 py-2">Date</th>
                    <th class="px-4 py-2">Actions</th>
                  </tr>
                </thead>
                <tbody id="archivedTableBody">
                  <!-- Archived entries will be inserted here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
    
        <!-- Export Modal -->
        <div id="exportModal" class="modal">
          <div class="modal-content" style="max-width: 500px !important;">
            <button onclick="closeExportModal()" class="modal-close-button">
              <i class="fas fa-times"></i>
            </button>
            <h2 class="text-xl font-bold mb-4">Export Options</h2>
            <div class="space-y-4">
                <button onclick="exportToXLSX()" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    <i class="fas fa-file-excel mr-2"></i>Export to XLSX
                </button>
                <button onclick="exportToCSV()" class="w-full bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                    <i class="fas fa-file-csv mr-2"></i>Export to CSV
                </button>
                <button onclick="exportToJSON()" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mb-2">
                    <i class="fas fa-file-code mr-2"></i>Export to JSON
                </button>
                <button onclick="exportToHTML()" class="w-full bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600 mb-2">
                    <i class="fas fa-file-alt mr-2"></i>Export to HTML
                </button>
                <button onclick="exportEmailList()" class="w-full bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600 mb-2">
                    <i class="fas fa-envelope mr-2"></i>Export Email List
                </button>
                <button onclick="createBackup()" class="w-full bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    <i class="fas fa-save mr-2"></i>Create Backup
                </button>
                <button onclick="showBackupsModal()" class="w-full bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    <i class="fas fa-history mr-2"></i>View Backups
                </button>
                <button onclick="purgeData()" class="w-full bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    <i class="fas fa-trash mr-2"></i>Purge Data
                </button>
            </div>
          </div>
        </div>
    
        <!-- Backups Modal -->
        <div id="backupsModal" class="modal">
          <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-xl font-bold">Recent Backups</h2>
              <button onclick="closeBackupsModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <ul id="backupsList" class="max-h-96 overflow-y-auto">
              <!-- Backup items will be inserted here -->
            </ul>
          </div>
        </div>
    
    <script>
    // Initialize variables
    let participants = [];
    let archivedParticipants = [];
    let backups = [];
    const maxBackups = 5;
    let currentPage = 1;
    const entriesPerPage = 8;
    let sortColumn = 0;
    let sortDirection = 'asc';
    let filteredParticipants = [];
    let isSearchActive = false;

    // Load data from localStorage
    document.addEventListener('DOMContentLoaded', function () {
      const savedParticipants = localStorage.getItem('participants');
      if (savedParticipants) {
        participants = JSON.parse(savedParticipants);
      }
      renderTable();
      
      if (document.getElementById('participantTableBody')) {
        new Sortable(document.getElementById('participantTableBody'), {
          animation: 150,
          ghostClass: 'bg-gray-100',
          onEnd: function () {
            updateParticipantOrder();
          }
        });
      }
      const dropdownButton = document.querySelector('.dropdown button');
      if (dropdownButton) {
        dropdownButton.addEventListener('click', function (e) {
          e.preventDefault();
          showExportModal();
        });
      }
      if (document.getElementById('dateFilter')) {
        flatpickr("#dateFilter", {
          mode: "range",
          dateFormat: "Y-m-d",
          onChange: function (selectedDates) {}
        });
      }
      const statusFilter = document.getElementById('statusFilter');
      if (statusFilter) {
        statusFilter.addEventListener('change', function (e) {
          const status = e.target.value;
          if (status) {
            participants = participants.filter(p => p.status === status);
          }
          currentPage = 1;
          renderTable();
        });
      }
      const prevButton = document.getElementById('prevPage');
      const nextButton = document.getElementById('nextPage');
      if (prevButton) {
        prevButton.addEventListener('click', () => {
          if (currentPage > 1) {
            currentPage--;
            renderTable();
          }
        });
      }
      if (nextButton) {
        nextButton.addEventListener('click', () => {
          if (currentPage < getTotalPages()) {
            currentPage++;
            renderTable();
          }
        });
      }
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', function (e) {
          const searchTerm = e.target.value.toLowerCase();
          const searchResults = document.getElementById('searchResults');
          if (!searchTerm) {
            searchResults.classList.add('hidden');
            return;
          }
          const allResults = [...participants, ...archivedParticipants].filter(p => Object.values(p).some(value => String(value).toLowerCase().includes(searchTerm)));
          searchResults.innerHTML = allResults.map(p => `
            <div class="search-result" onclick="openEditModal(${p.id}, ${archivedParticipants.includes(p)})">
              <span>${p.name}</span>
              ${archivedParticipants.includes(p) ? '<span class="archived-tag">Archived</span>' : ''}
              <div class="text-sm text-gray-500">
                ${p.email || ''} ${p.telegram || ''} ${p.twitter || ''}
              </div>
            </div>
          `).join('');
          searchResults.classList.remove('hidden');
        });
      }
    });

    function maskSocialHandle(handle) {
      if (!handle) return '';
      if (handle.startsWith('@')) {
        const username = handle.substring(1);
        if (username.length <= 4) return handle;
        return '@' + username.substring(0, 2) + '...' + username.substring(username.length - 2);
      }
      if (handle.length <= 4) return handle;
      return handle.substring(0, 2) + '...' + handle.substring(handle.length - 2);
    }
    function maskEmail(email) {
      if (!email) return '';
      const [local, domain] = email.split('@');
      if (!domain) return email;
      return `${local.substring(0, 2)}...@${domain}`;
    }
    function maskAddress(address) {
      if (!address) return '';
      if (address.length <= 8) return address;
      return `${address.substring(0, 4)}...${address.substring(address.length - 4)}`;
    }
    function renderTable() {
      updateWalletCount();
      const tbody = document.getElementById('participantTableBody');
      if (!tbody) return;
      tbody.innerHTML = '';

      const displayList = isSearchActive ? filteredParticipants : participants;
      const startIndex = (currentPage - 1) * entriesPerPage;
      const endIndex = startIndex + entriesPerPage;
      const displayedParticipants = displayList.slice(startIndex, endIndex);

      displayedParticipants.forEach((p, index) => {
        const hasAddresses = (p.solanaAddresses?.length > 0 || p.baseAddresses?.length > 0 || p.polygonAddresses?.length > 0);
        const walletColor = hasAddresses ? 'text-orange-500 hover:text-orange-700' : 'text-purple-500 hover:text-purple-700';
        const actualIndex = participants.indexOf(p); // Get actual index from main participants array
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-4 py-2">${startIndex + index + 1}</td>
          <td class="px-4 py-2">${p.name || ''}</td>
          <td class="px-4 py-2"><span class="px-2 py-1 rounded ${p.status === 'Winner' ? 'bg-green-200' : 'bg-yellow-200'}">${p.status || ''}</span></td>
          <td class="px-4 py-2">${p.telegram || ''}</td>
          <td class="px-4 py-2">${p.twitter || ''}</td>
          <td class="px-4 py-2">${p.discord || ''}</td>
          <td class="px-4 py-2">${p.email || ''}</td>
          <td class="px-4 py-2">
            <button onclick="toggleInfo(${p.id})" class="text-blue-500 hover:text-blue-700">
              <i class="fas fa-info-circle"></i>
            </button>
            <div id="info-${p.id}" class="expanded-info">${p.info || ''}</div>
          </td>
          <td class="px-4 py-2">
            ${p.imageUrl ? `<img src="${p.imageUrl}" class="thumbnail" alt="Participant image">` : '-'}
          </td>
          <td class="px-4 py-2">${p.date || ''}</td>
          <td class="px-4 py-2">
            <button onclick="toggleWallets(${p.id})" class="${walletColor} hover:text-purple-700 mr-2">
              <i class="fas fa-wallet"></i>
            </button>
            <div id="wallets-${p.id}" class="wallet-info">
              ${getWalletHtml(p.solanaAddresses, 'Solana')}
              ${getWalletHtml(p.baseAddresses, 'Base Chain')}
              ${getWalletHtml(p.polygonAddresses, 'Polygon')}
            </div>
            <button onclick="editEntry(${actualIndex})" class="text-blue-500 hover:text-blue-700 mr-2">
              <i class="fas fa-edit"></i>
            </button>
            <button onclick="archiveEntry(${p.id})" class="text-gray-500 hover:text-gray-700 mr-2">
              <i class="fas fa-archive"></i>
            </button>
            <button onclick="deleteEntry(${actualIndex})" class="text-red-500 hover:text-red-700">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Update pagination info
      const totalPages = Math.ceil((isSearchActive ? filteredParticipants : participants).length / entriesPerPage);
      document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
      
      // Update total count
      const totalCountElement = document.getElementById('totalCount');
      if (totalCountElement) {
        totalCountElement.textContent = displayList.length;
      }
    }

    function searchParticipants() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const searchResults = document.getElementById('searchResults');
      searchResults.innerHTML = '';

      if (!searchTerm) {
        searchResults.style.display = 'none';
        isSearchActive = false;
        filteredParticipants = [];
        currentPage = 1;
        renderTable();
        return;
      }

      const matches = participants.filter(p => {
        return (
          (p.name && p.name.toLowerCase().includes(searchTerm)) ||
          (p.telegram && p.telegram.toLowerCase().includes(searchTerm)) ||
          (p.twitter && p.twitter.toLowerCase().includes(searchTerm)) ||
          (p.discord && p.discord.toLowerCase().includes(searchTerm)) ||
          (p.email && p.email.toLowerCase().includes(searchTerm)) ||
          (p.info && p.info.toLowerCase().includes(searchTerm)) ||
          (p.status && p.status.toLowerCase().includes(searchTerm))
        );
      });

      if (matches.length > 0) {
        searchResults.style.display = 'block';
        matches.forEach((p, index) => {
          const div = document.createElement('div');
          div.className = 'p-2 hover:bg-gray-100 cursor-pointer';
          div.onclick = () => selectSearchResult(participants.indexOf(p));
          div.innerHTML = `
            <div class="font-bold">${p.name || 'No Name'}</div>
            <div class="text-sm text-gray-600">
              ${p.telegram ? `Telegram: ${p.telegram}` : ''}
              ${p.email ? `Email: ${p.email}` : ''}
              ${p.status ? `Status: ${p.status}` : ''}
            </div>
          `;
          searchResults.appendChild(div);
        });
      } else {
        searchResults.style.display = 'none';
      }

      // Update the main table with filtered results
      isSearchActive = true;
      filteredParticipants = matches;
      currentPage = 1;
      renderTable();
    }

    function selectSearchResult(index) {
      if (index >= 0 && index < participants.length) {
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        searchResults.style.display = 'none';
        isSearchActive = true;
        filteredParticipants = [participants[index]];
        currentPage = 1;
        renderTable();
      }
    }

    function clearSearch() {
      document.getElementById('searchInput').value = '';
      isSearchActive = false;
      filteredParticipants = [];
      currentPage = 1;
      renderTable();
    }

    document.getElementById('entryForm').onsubmit = function(e) {
      e.preventDefault();
      const editId = document.getElementById('editId').value;
      
      const entry = {
        id: editId ? parseInt(editId) : participants.length,
        name: document.getElementById('participantName').value,
        telegram: document.getElementById('telegram').value,
        twitter: document.getElementById('twitter').value,
        discord: document.getElementById('discord').value,
        email: document.getElementById('email').value,
        status: document.getElementById('status').value,
        info: document.getElementById('info').value,
        imageUrl: document.getElementById('imageUrl').value,
        date: document.getElementById('entryDate').value || new Date().toISOString().split('T')[0],
        solanaAddresses: getAddressValues('solana'),
        baseAddresses: getAddressValues('base'),
        polygonAddresses: getAddressValues('polygon')
      };

      const imageFile = document.getElementById('imageUpload').files[0];
      
      if (imageFile) {
        const reader = new FileReader();
        reader.onloadend = function() {
          entry.imageUrl = reader.result;
          saveEntryToList(entry, editId);
        };
        reader.readAsDataURL(imageFile);
      } else {
        saveEntryToList(entry, editId);
      }
      
      return false; // Prevent form submission
    };

    function saveEntryToList(entry, editId) {
      if (editId) {
        participants[parseInt(editId)] = entry;
      } else {
        participants.push(entry);
      }
      
      // Save to localStorage
      localStorage.setItem('participants', JSON.stringify(participants));
      
      // Close modal and update display
      document.getElementById('entryModal').style.display = 'none';
      
      // Update search results if search is active
      if (isSearchActive) {
        searchParticipants();
      } else {
        renderTable();
      }
    }

    function deleteEntry(index) {
      if (confirm('Are you sure you want to delete this entry?')) {
        const startIndex = (currentPage - 1) * entriesPerPage;
        const filteredParticipants = participants.slice(startIndex, startIndex + entriesPerPage);
        const entryToDelete = filteredParticipants[index];
        
        // Find the actual index in the main participants array
        const mainIndex = participants.findIndex(p => 
          p.telegram === entryToDelete.telegram &&
          p.twitter === entryToDelete.twitter &&
          p.discord === entryToDelete.discord &&
          p.email === entryToDelete.email &&
          p.date === entryToDelete.date
        );
        
        if (mainIndex !== -1) {
          participants.splice(mainIndex, 1);
          localStorage.setItem('participants', JSON.stringify(participants));
          renderTable();
        }
      }
    }
    function toggleInfo(id) {
      const infoDiv = document.getElementById(`info-${id}`);
      infoDiv.style.display = infoDiv.style.display === 'none' ? 'block' : 'none';
    }
    function toggleFilters() {
      const filterPanel = document.getElementById('filterPanel');
      filterPanel.classList.toggle('hidden');
    }
    function importXLSX() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.xlsx,.xls';
      input.onchange = function (e) {
        try {
          const file = e.target.files[0];
          if (!file) {
            throw new Error('No file selected');
          }

          const reader = new FileReader();
          reader.onerror = function(error) {
            console.error('FileReader error:', error);
            alert('Error reading file: ' + error.message);
          };

          reader.onload = function (e) {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
              const jsonData = XLSX.utils.sheet_to_json(firstSheet, { raw: false, defval: '' });

              if (!Array.isArray(participants)) {
                participants = [];
              }

              let importCount = 0;
              let errors = [];
              
              // Debug: Log the first row to see exact column names
              if (jsonData.length > 0) {
                console.log('First row column names:', Object.keys(jsonData[0]));
              }

              // Check if this is a submission format
              const isSubmissionFormat = jsonData.length > 0 && (
                Object.keys(jsonData[0]).some(key => 
                  key.includes('EmailAddress') || 
                  key.includes('Solana Wallet Address') ||
                  key.includes('Any Other Information')
                )
              );

              console.log('Is submission format:', isSubmissionFormat);

              if (isSubmissionFormat) {
                // Handle submission format
                jsonData.forEach((row, index) => {
                  try {
                    console.log(`Processing row ${index}:`, row);
                    
                    // Find the actual column names that match our expected fields
                    const emailColumn = Object.keys(row).find(key => 
                      key === 'EmailAddress' || 
                      key.toLowerCase().includes('email') || 
                      key.toLowerCase().includes('mail')
                    );
                    const infoColumn = Object.keys(row).find(key => key.includes('Information'));
                    
                    console.log('Found columns:', { 
                      emailColumn, 
                      infoColumn,
                      'All columns': Object.keys(row),
                      'Email value': emailColumn ? row[emailColumn] : 'No email column found'
                    });

                    // Get email value with fallbacks
                    let emailValue = '';
                    if (emailColumn) {
                      emailValue = row[emailColumn];
                    } else {
                      // Try common variations
                      const emailVariations = ['EmailAddress', 'Email Address', 'Email', 'Mail'];
                      for (const variation of emailVariations) {
                        if (row[variation]) {
                          emailValue = row[variation];
                          break;
                        }
                      }
                    }
                    console.log('Email value found:', emailValue);

                    const newParticipant = {
                      name: row['Telegram'] || '',
                      telegram: row['Telegram'] || '',
                      twitter: row['X (Twitter)'] || '',
                      discord: row['Discord'] || '',
                      email: emailValue ? emailValue.toString().trim() : '',
                      status: 'Pending',
                      info: infoColumn ? (row[infoColumn] || '').toString().trim() : '',
                      imageUrl: row['Thunbnail Image URL'] || '',
                      date: new Date().toISOString().split('T')[0],
                      solanaAddresses: row['Solana Wallet Address'] ? [row['Solana Wallet Address'].toString().trim()] : [],
                      baseAddresses: row['Base Chain Address'] ? [row['Base Chain Address'].toString().trim()] : [],
                      polygonAddresses: row['Polygon Chain Address'] ? [row['Polygon Chain Address'].toString().trim()] : []
                    };

                    console.log('Created participant:', {
                      email: newParticipant.email,
                      emailColumn,
                      emailValue,
                      rawRow: row
                    });

                    // Validate the participant
                    if (!newParticipant.email && emailValue) {
                      errors.push(`Row ${index + 1}: Email address not properly imported. Raw value: ${emailValue}`);
                    }
                    if (!newParticipant.telegram) {
                      errors.push(`Row ${index + 1}: Telegram is empty`);
                    }

                    participants.push(newParticipant);
                    importCount++;
                  } catch (rowError) {
                    console.error(`Error processing row ${index}:`, rowError);
                    errors.push(`Row ${index + 1}: ${rowError.message}`);
                  }
                });
              } else {
                // Handle existing formats
                const dataRows = jsonData.slice(2);
                dataRows.forEach((row, index) => {
                  try {
                    // ... [existing code for other formats] ...
                    const findValue = (possibleNames) => {
                      for (const name of possibleNames) {
                        for (const [key, value] of Object.entries(row)) {
                          const keyLower = key.toLowerCase();
                          if (keyLower.includes(name.toLowerCase()) && value) {
                            return value.toString().trim();
                          }
                        }
                      }
                      return '';
                    };

                    // ... rest of the existing format handling ...
                    const telegram = findValue(['telegram', '__EMPTY_1', 'tg']);
                    const twitter = findValue(['twitter', '__EMPTY_6', 'x', 'tweet']);
                    const discord = findValue(['discord', '__EMPTY_7', 'dc']);
                    const email = findValue(['email', '__EMPTY', 'mail']);
                    const status = findValue(['status', '__EMPTY_2', 'state']) || 'Pending';
                    const info = findValue(['info', '__EMPTY_4', 'notes', 'description']);
                    const imageUrl = findValue(['image', '__EMPTY_5', 'img', 'url']);
                    const date = findValue(['date', '__EMPTY_11']) || new Date().toISOString().split('T')[0];

                    // ... rest of existing code ...
                    const newParticipant = {
                      name: telegram || '',
                      telegram: telegram || '',
                      twitter: twitter || '',
                      discord: discord || '',
                      email: email || '',
                      status: status || 'Pending',
                      info: info || '',
                      imageUrl: imageUrl === '-' ? '' : (imageUrl || ''),
                      date: date || new Date().toISOString().split('T')[0],
                      solanaAddresses: [],
                      baseAddresses: [],
                      polygonAddresses: []
                    };

                    participants.push(newParticipant);
                    importCount++;
                  } catch (rowError) {
                    console.error(`Error processing legacy row ${index}:`, rowError);
                    errors.push(`Row ${index + 1}: ${rowError.message}`);
                  }
                });
              }

              localStorage.setItem('participants', JSON.stringify(participants));
              renderTable();

              // Show results
              let message = `Successfully imported ${importCount} entries.`;
              if (errors.length > 0) {
                message += `\n\nWarnings:\n${errors.join('\n')}`;
              }
              alert(message);

            } catch (error) {
              console.error('Error processing file:', error);
              alert('Error processing file: ' + error.message);
            }
          };

          reader.readAsArrayBuffer(file);
        } catch (error) {
          console.error('Error in import:', error);
          alert('Error importing file: ' + error.message);
        }
      };
      input.click();
    }

    function purgeData() {
      if (confirm('Are you sure you want to purge all participant data? This cannot be undone.')) {
        participants = [];
        localStorage.setItem('participants', JSON.stringify(participants));
        renderTable();
        alert('All participant data has been purged.');
      }
    }

    function createBackup() {
      const backup = {
        participants: participants,
        appState: {
          currentPage: currentPage,
          entriesPerPage: entriesPerPage,
          sortColumn: sortColumn,
          sortDirection: sortDirection,
          filters: {
            status: document.getElementById('statusFilter')?.value || '',
            date: document.getElementById('dateFilter')?.value || '',
            hasImage: document.getElementById('hasImageFilter')?.checked || false,
            hasInfo: document.getElementById('hasInfoFilter')?.checked || false,
            solana: document.getElementById('solanaFilter')?.checked || false,
            base: document.getElementById('baseFilter')?.checked || false,
            polygon: document.getElementById('polygonFilter')?.checked || false
          }
        }
      };

      let backups = JSON.parse(localStorage.getItem('backups') || '[]');
      backups.push({
        date: new Date().toISOString(),
        data: JSON.stringify(backup)
      });
      
      // Keep only the last 10 backups
      if (backups.length > 10) {
        backups = backups.slice(-10);
      }
      
      localStorage.setItem('backups', JSON.stringify(backups));
      showBackupsModal();
    }
    function restoreBackup(backupData) {
      try {
        const backup = JSON.parse(backupData);
        if (backup && backup.participants) {
          participants = backup.participants;
          localStorage.setItem('participants', JSON.stringify(participants));
          
          // Restore app state if it exists
          if (backup.appState) {
            currentPage = backup.appState.currentPage || 1;
            entriesPerPage = backup.appState.entriesPerPage || 10;
            sortColumn = backup.appState.sortColumn || '';
            sortDirection = backup.appState.sortDirection || '';
          }
          
          // Restore filters if they exist
          if (backup.appState?.filters) {
            const statusFilter = document.getElementById('statusFilter');
            const dateFilter = document.getElementById('dateFilter');
            const hasImageFilter = document.getElementById('hasImageFilter');
            const hasInfoFilter = document.getElementById('hasInfoFilter');
            const solanaFilter = document.getElementById('solanaFilter');
            const baseFilter = document.getElementById('baseFilter');
            const polygonFilter = document.getElementById('polygonFilter');

            if (statusFilter) statusFilter.value = backup.appState.filters.status || '';
            if (dateFilter) dateFilter.value = backup.appState.filters.date || '';
            if (hasImageFilter) hasImageFilter.checked = backup.appState.filters.hasImage || false;
            if (hasInfoFilter) hasInfoFilter.checked = backup.appState.filters.hasInfo || false;
            if (solanaFilter) solanaFilter.checked = backup.appState.filters.solana || false;
            if (baseFilter) baseFilter.checked = backup.appState.filters.base || false;
            if (polygonFilter) polygonFilter.checked = backup.appState.filters.polygon || false;
          }
          
          renderTable();
          alert('Backup restored successfully!');
          document.getElementById('backupsModal').style.display = 'none';
        } else {
          throw new Error('Invalid backup data structure');
        }
      } catch (error) {
        console.error('Error restoring backup:', error);
        alert('Failed to restore backup: ' + error.message);
      }
    }

    function exportToXLSX() {
        // Create the header rows first
        const exportData = [
            {
                '__EMPTY': '',
                '__EMPTY_1': '',
                '__EMPTY_2': '',
                '__EMPTY_3': '',
                '__EMPTY_4': '',
                '__EMPTY_5': 'User-defined Award Information',
                '__EMPTY_6': '',
                '__EMPTY_7': '',
                '__EMPTY_8': 'Wallet Information',
                '__EMPTY_9': '',
                '__EMPTY_10': '',
                '__EMPTY_11': ''
            },
            {
                '__EMPTY': 'Email',
                '__EMPTY_1': 'Telegram',
                '__EMPTY_2': 'Status',
                '__EMPTY_3': 'Quantity',
                '__EMPTY_4': 'Info',
                '__EMPTY_5': 'Image',
                '__EMPTY_6': 'Twitter',
                '__EMPTY_7': 'Discord',
                '__EMPTY_8': 'Solana Addresses',
                '__EMPTY_9': 'Base Addresses',
                '__EMPTY_10': 'Polygon Addresses',
                '__EMPTY_11': 'Date'
            }
        ];

        // Add participant data
        participants.forEach(p => {
            const row = {
                '__EMPTY': p.email || '',
                '__EMPTY_1': p.telegram || '',
                '__EMPTY_2': p.status || 'Pending',
                '__EMPTY_3': '1',
                '__EMPTY_4': p.info || '',
                '__EMPTY_5': p.imageUrl || '-',
                '__EMPTY_6': p.twitter || '',
                '__EMPTY_7': p.discord || '',
                '__EMPTY_8': (p.solanaAddresses || []).join(','),
                '__EMPTY_9': (p.baseAddresses || []).join(','),
                '__EMPTY_10': (p.polygonAddresses || []).join(','),
                '__EMPTY_11': p.date || new Date().toISOString().split('T')[0]
            };
            exportData.push(row);
        });

        const ws = XLSX.utils.json_to_sheet(exportData, {skipHeader: true});
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Participants");
        
        const filename = `WIFElist_export_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, filename);
    }

    function exportToCSV() {
        const headers = [
            'Name', 'Status', 'Telegram', 'Twitter', 'Discord', 'Email',
            'Info', 'Image URL', 'Date', 'Solana Addresses', 'Base Addresses', 'Polygon Addresses'
        ];

        const rows = participants.map(p => [
            p.name,
            p.status,
            p.telegram,
            p.twitter,
            p.discord,
            p.email,
            p.info,
            p.imageUrl,
            p.date,
            (p.solanaAddresses || []).join('|'),
            (p.baseAddresses || []).join('|'),
            (p.polygonAddresses || []).join('|')
        ].map(value => `"${(value || '').toString().replace(/"/g, '""')}"`));

        const csv = [
            headers.join(','),
            ...rows.map(row => row.join(','))
        ].join('\n');

        downloadFile(csv, `WIFElist_export_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
    }

    function exportToJSON() {
        const data = {
            exportDate: new Date().toISOString(),
            participants: participants,
            metadata: {
                totalEntries: participants.length,
                entriesWithWallets: participants.filter(p => 
                    (p.solanaAddresses?.length > 0) || 
                    (p.baseAddresses?.length > 0) || 
                    (p.polygonAddresses?.length > 0)
                ).length
            }
        };

        const json = JSON.stringify(data, null, 2);
        downloadFile(json, `WIFElist_export_${new Date().toISOString().split('T')[0]}.json`, 'application/json');
    }

    function exportToHTML() {
      const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>WIFE List Export</title>
          <style>
            body { 
              font-family: 'Dancing Script', cursive;
              margin: 20px;
              background-color: white;
              color: #4a5568;
            }
            @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap');
            table { 
              width: 100%;
              border-collapse: collapse;
              margin-bottom: 20px;
              background-color: white;
              box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            th, td { 
              border: 1px solid #fed7e2;
              padding: 12px;
              text-align: left;
            }
            th { 
              background-color: #fed7e2;
              color: #702459;
              font-family: Arial, sans-serif;
            }
            tr:nth-child(even) { background-color: #fff5f7; }
            .print-button {
              display: block;
              width: 200px;
              margin: 20px auto;
              padding: 12px;
              background-color: #ed64a6;
              color: white;
              text-align: center;
              border: none;
              border-radius: 25px;
              cursor: pointer;
              text-decoration: none;
              font-family: Arial, sans-serif;
              transition: all 0.3s ease;
            }
            .print-button:hover { 
              background-color: #d53f8c;
              transform: translateY(-2px);
            }
            h1 {
              text-align: center;
              color: #702459;
              font-size: 2.5em;
              margin-bottom: 0.5em;
            }
            .timestamp {
              text-align: center;
              color: #805ad5;
              margin-bottom: 2em;
              font-family: Arial, sans-serif;
            }
            @media print {
              .print-button { display: none; }
              body { background-color: white; }
            }
          </style>
        </head>
        <body>
          <h1>WIFE List Export</h1>
          <p class="timestamp">Generated on: ${new Date().toLocaleString()}</p>
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Status</th>
                <th>Telegram</th>
                <th>Twitter</th>
                <th>Discord</th>
                <th>Email</th>
                <th>Info</th>
                <th>Wallets</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              ${participants.map((p, i) => {
                // Function to partially hide data
                const hideData = (str, start = 2, end = 2) => {
                  if (!str) return '';
                  if (str.length <= start + end) return str;
                  return str.slice(0, start) + ''.repeat(str.length - start - end) + str.slice(-end);
                };

                // Function to hide wallet addresses
                const hideWallet = (addr) => {
                  if (!addr) return '';
                  return addr.slice(0, 4) + ''.repeat(addr.length - 8) + addr.slice(-4);
                };

                return `
                  <tr>
                    <td>${i + 1}</td>
                    <td>${hideData(p.name) || ''}</td>
                    <td>${p.status || ''}</td>
                    <td>${hideData(p.telegram) || ''}</td>
                    <td>${hideData(p.twitter) || ''}</td>
                    <td>${hideData(p.discord) || ''}</td>
                    <td>${hideData(p.email, 3, 8) || ''}</td>
                    <td>${hideData(p.info) || ''}</td>
                    <td>
                      ${p.solanaAddresses ? `<div>Solana: ${p.solanaAddresses.map(hideWallet).join(', ')}</div>` : ''}
                      ${p.baseAddresses ? `<div>Base: ${p.baseAddresses.map(hideWallet).join(', ')}</div>` : ''}
                      ${p.polygonAddresses ? `<div>Polygon: ${p.polygonAddresses.map(hideWallet).join(', ')}</div>` : ''}
                    </td>
                    <td>${p.date || ''}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
          <button onclick="window.print()" class="print-button">Print to PDF</button>
        </body>
        </html>
      `;

      const blob = new Blob([htmlContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'WIFE_List_Export.html';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    function downloadFile(content, fileName, contentType) {
        const a = document.createElement('a');
        const file = new Blob([content], { type: contentType });
        const url = URL.createObjectURL(file);
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 0);
    }
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {});
    }
    function toggleWallets(id) {
      const walletsDiv = document.getElementById(`wallets-${id}`);
      walletsDiv.style.display = walletsDiv.style.display === 'none' ? 'block' : 'none';
    }
    function showArchivedEntries() {
      document.getElementById('archivedModal').style.display = 'block';
      renderArchivedTable();
    }

    function renderArchivedTable() {
      const tbody = document.getElementById('archivedTableBody');
      tbody.innerHTML = '';
      
      // Filter for archived entries
      const archivedEntries = participants.filter(p => p.status === 'Archived');
      
      archivedEntries.forEach((p, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-4 py-2">${index + 1}</td>
          <td class="px-4 py-2">${p.id}</td>
          <td class="px-4 py-2">${p.name}</td>
          <td class="px-4 py-2"><span class="px-2 py-1 rounded bg-gray-200">Archived</span></td>
          <td class="px-4 py-2">${p.telegram || '-'}</td>
          <td class="px-4 py-2">${p.twitter || '-'}</td>
          <td class="px-4 py-2">${p.discord || '-'}</td>
          <td class="px-4 py-2">${p.email || '-'}</td>
          <td class="px-4 py-2">
            <button onclick="toggleInfo(${p.id})" class="text-blue-500 hover:text-blue-700">
              <i class="fas fa-info-circle"></i>
            </button>
            <div id="info-${p.id}" class="hidden">${p.info || '-'}</div>
          </td>
          <td class="px-4 py-2">
            ${p.imageUrl ? `<img src="${p.imageUrl}" class="w-8 h-8 object-cover rounded" alt="Participant image">` : '-'}
          </td>
          <td class="px-4 py-2">${p.date}</td>
          <td class="px-4 py-2">
            <button onclick="unarchiveEntry(${p.id})" class="text-green-500 hover:text-green-700" title="Unarchive">
              <i class="fas fa-box-open"></i>
            </button>
            <button onclick="toggleWallets(${p.id})" class="text-purple-500 hover:text-purple-700 ml-2" title="View Wallets">
              <i class="fas fa-wallet"></i>
            </button>
            <div id="wallets-${p.id}" class="hidden">
              ${getWalletHtml(p.solanaAddresses, 'Solana')}
              ${getWalletHtml(p.baseAddresses, 'Base')}
              ${getWalletHtml(p.polygonAddresses, 'Polygon')}
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function unarchiveEntry(id) {
      const entry = participants.find(p => p.id === id);
      if (entry && entry.status === 'Archived') {
        entry.status = 'Pending';
        renderTable();
        renderArchivedTable();
      }
    }

    function getWalletHtml(addresses, chainName) {
      if (!addresses || addresses.length === 0) return '';
      return `
        <div class="wallet-chain-section">
          <span class="font-semibold">${chainName}:</span>
          ${addresses.map(addr => `
            <div class="wallet-address-row">
              <span>${addr}</span>
              <button onclick="copyToClipboard('${addr}')" class="copy-button">
                Copy
              </button>
            </div>
          `).join('')}
        </div>
      `;
    }
    function addAddressField(type) {
      const container = document.getElementById(`${type}AddressContainer`);
      const div = document.createElement('div');
      div.className = 'flex gap-2 mb-2';
      div.innerHTML = `
        <input type="text" class="${type}Address mt-1 block w-full rounded border-gray-300">
        <button type="button" onclick="addAddressField('${type}')" class="bg-blue-500 text-white px-2 rounded">+</button>
      `;
      container.appendChild(div);
    }
    function removeAddressField(button) {
      if (confirm('Are you sure you want to remove this address?')) {
        button.parentElement.remove();
      }
    }
    function getAddressValues(type) {
      return Array.from(document.querySelectorAll(`.${type}Address`)).map(input => input.value).filter(val => val.trim() !== '');
    }
    function addAddressWithValue(type, value) {
      const container = document.getElementById(`${type}AddressContainer`);
      const div = document.createElement('div');
      div.className = 'flex gap-2 mb-2';
      div.innerHTML = `
        <input type="text" class="${type}Address mt-1 block w-full rounded border-gray-300" value="${value}">
        <button type="button" onclick="removeAddressField(this)" class="bg-red-500 text-white px-2 rounded">-</button>
      `;
      container.appendChild(div);
    }
    function updateRowNumbers() {
      const rows = document.querySelectorAll('#participantTableBody tr');
      rows.forEach((row, index) => {
        row.querySelector('td:first-child').textContent = (index + 1).toString();
      });
    }
    function sortTable(colIndex) {
      const table = document.getElementById('participantTableBody');
      currentPage = 1;
      const rows = Array.from(table.getElementsByTagName('tr'));
      const isAsc = table.getAttribute('data-sort') === 'asc';
      rows.sort((a, b) => {
        const aCol = a.getElementsByTagName('td')[colIndex].textContent;
        const bCol = b.getElementsByTagName('td')[colIndex].textContent;
        if (!isNaN(aCol) && !isNaN(bCol)) {
          return isAsc ? aCol - bCol : bCol - aCol;
        }
        return isAsc ? aCol.localeCompare(bCol) : bCol.localeCompare(aCol);
      });
      rows.forEach(row => table.appendChild(row));
      table.setAttribute('data-sort', isAsc ? 'desc' : 'asc');
      updateRowNumbers();
    }
    function getTotalPages() {
      return Math.ceil(participants.length / entriesPerPage);
    }
    function getPageEntries() {
      const start = (currentPage - 1) * entriesPerPage;
      const end = start + entriesPerPage;
      return participants.slice(start, end);
    }
    function showExportModal() {
      document.getElementById('exportModal').style.display = 'block';
    }

    function closeExportModal() {
      document.getElementById('exportModal').style.display = 'none';
    }
    function exportEmailList() {
        // Filter out entries without emails
        const emailList = participants
            .filter(p => p.email && p.email.trim() !== '')
            .map(p => p.email.trim())
            .join('; ');

        // Create a temporary textarea to copy the emails
        const tempTextArea = document.createElement('textarea');
        tempTextArea.value = emailList;
        document.body.appendChild(tempTextArea);
        tempTextArea.select();
        
        try {
            // Copy to clipboard
            document.execCommand('copy');
            alert('Email list copied to clipboard! You can now paste it into your email client.');
        } catch (err) {
            alert('Failed to copy to clipboard. Email list:\n\n' + emailList);
        } finally {
            document.body.removeChild(tempTextArea);
        }
    }

    function applyFilters() {
      let filteredParticipants = [...participants];

      // Status filter
      const statusFilter = document.getElementById('statusFilter')?.value;
      if (statusFilter) {
        filteredParticipants = filteredParticipants.filter(p => p.status === statusFilter);
      }

      // Date filter
      const dateFilter = document.getElementById('dateFilter')?.value;
      if (dateFilter) {
        filteredParticipants = filteredParticipants.filter(p => p.date === dateFilter);
      }

      // Image filter
      const hasImageFilter = document.getElementById('hasImageFilter')?.checked;
      if (hasImageFilter) {
        filteredParticipants = filteredParticipants.filter(p => p.imageUrl && p.imageUrl !== '');
      }

      // Info filter
      const hasInfoFilter = document.getElementById('hasInfoFilter')?.checked;
      if (hasInfoFilter) {
        filteredParticipants = filteredParticipants.filter(p => p.info && p.info !== '');
      }

      // Wallet filters
      const solanaFilter = document.getElementById('solanaFilter')?.checked;
      if (solanaFilter) {
        filteredParticipants = filteredParticipants.filter(p => p.solanaAddresses && p.solanaAddresses.length > 0);
      }

      const baseFilter = document.getElementById('baseFilter')?.checked;
      if (baseFilter) {
        filteredParticipants = filteredParticipants.filter(p => p.baseAddresses && p.baseAddresses.length > 0);
      }

      const polygonFilter = document.getElementById('polygonFilter')?.checked;
      if (polygonFilter) {
        filteredParticipants = filteredParticipants.filter(p => p.polygonAddresses && p.polygonAddresses.length > 0);
      }

      return filteredParticipants;
    }

    function clearFilters() {
      // Reset all filter inputs
      const statusFilter = document.getElementById('statusFilter');
      const dateFilter = document.getElementById('dateFilter');
      if (statusFilter) statusFilter.value = '';
      if (dateFilter) dateFilter.value = '';
      
      // Reset checkboxes
      ['solanaFilter', 'baseFilter', 'polygonFilter',
       'telegramFilter', 'twitterFilter', 'discordFilter',
       'hasImageFilter', 'hasInfoFilter'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.checked = false;
      });

      // Reload original data
      if (localStorage.getItem('participants')) {
        participants = JSON.parse(localStorage.getItem('participants'));
      }
      currentPage = 1;
      renderTable();
    }

    function showBackupsModal() {
      const backups = JSON.parse(localStorage.getItem('backups') || '[]');
      const modal = document.getElementById('backupsModal');
      const backupsList = document.getElementById('backupsList');
      backupsList.innerHTML = '';
      
      // Add purge backups button at the top
      const purgeButton = document.createElement('div');
      purgeButton.className = 'mb-4';
      purgeButton.innerHTML = `
        <button onclick="purgeBackups()" class="bg-red-500 text-white px-4 py-2 rounded text-sm hover:bg-red-600">
          Purge All Backups
        </button>
      `;
      backupsList.appendChild(purgeButton);
      
      backups.forEach((backup, index) => {
        const date = new Date(backup.date).toLocaleString();
        const li = document.createElement('li');
        li.className = 'py-2 border-b';
        li.innerHTML = `
          <div class="flex justify-between items-center">
            <span>${date}</span>
            <div>
              <button onclick="restoreBackup(${index})" class="bg-blue-500 text-white px-2 py-1 rounded text-sm mr-2 hover:bg-blue-600">
                Restore
              </button>
              <button onclick="deleteBackup(${index})" class="bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600">
                Delete
              </button>
            </div>
          </div>
        `;
        backupsList.appendChild(li);
      });
      
      modal.style.display = 'block';
    }

    function closeBackupsModal() {
      document.getElementById('backupsModal').style.display = 'none';
    }

    function purgeBackups() {
      if (confirm('Are you sure you want to delete ALL backups? This cannot be undone.')) {
        localStorage.removeItem('backups');
        showBackupsModal(); // Refresh the modal
        alert('All backups have been purged.');
      }
    }

    function deleteBackup(index) {
      if (confirm('Are you sure you want to delete this backup?')) {
        const backups = JSON.parse(localStorage.getItem('backups') || '[]');
        backups.splice(index, 1);
        localStorage.setItem('backups', JSON.stringify(backups));
        showBackupsModal(); // Refresh the modal
      }
    }

    function updateWalletCount() {
      const count = participants.filter(p => 
        (p.solanaAddresses?.length > 0) || 
        (p.baseAddresses?.length > 0) || 
        (p.polygonAddresses?.length > 0)
      ).length;
      
      const walletCountElement = document.getElementById('walletCount');
      if (walletCountElement) {
        walletCountElement.textContent = count;
      }
    }

    function showAddModal() {
      document.getElementById('modalTitle').textContent = 'Add New Entry';
      document.getElementById('editId').value = '';
      document.getElementById('entryForm').reset();
      document.getElementById('imageUpload').value = '';
      document.getElementById('solanaAddressContainer').innerHTML = '<div class="flex gap-2 mb-2"><input type="text" class="solanaAddress mt-1 block w-full rounded border-gray-300"><button type="button" onclick="addAddressField(\'solana\')" class="bg-blue-500 text-white px-2 rounded">+</button></div>';
      document.getElementById('baseAddressContainer').innerHTML = '<div class="flex gap-2 mb-2"><input type="text" class="baseAddress mt-1 block w-full rounded border-gray-300"><button type="button" onclick="addAddressField(\'base\')" class="bg-blue-500 text-white px-2 rounded">+</button></div>';
      document.getElementById('polygonAddressContainer').innerHTML = '<div class="flex gap-2 mb-2"><input type="text" class="polygonAddress mt-1 block w-full rounded border-gray-300"><button type="button" onclick="addAddressField(\'polygon\')" class="bg-blue-500 text-white px-2 rounded">+</button></div>';
      document.getElementById('status').value = 'Manual';
      document.getElementById('entryDate').value = '';
      flatpickr("#entryDate", {
        dateFormat: "Y-m-d",
        defaultDate: new Date()
      });
      document.getElementById('entryModal').style.display = 'block';
    }

    function editEntry(index) {
      const entry = participants[index];
      
      console.log('Edit entry:', {
        index,
        'Total participants': participants.length,
        'Entry found': entry ? 'yes' : 'no'
      });
      
      if (!entry) {
        console.error('Entry not found:', index);
        return;
      }

      document.getElementById('modalTitle').textContent = 'Edit Entry';
      document.getElementById('editId').value = index;

      // Clear previous wallet address fields
      document.getElementById('solanaAddressContainer').innerHTML = '';
      document.getElementById('baseAddressContainer').innerHTML = '';
      document.getElementById('polygonAddressContainer').innerHTML = '';
      
      // Populate form fields
      document.getElementById('participantName').value = entry.name || '';
      document.getElementById('telegram').value = entry.telegram || '';
      document.getElementById('twitter').value = entry.twitter || '';
      document.getElementById('discord').value = entry.discord || '';
      document.getElementById('email').value = entry.email || '';
      document.getElementById('status').value = entry.status || 'Manual';
      document.getElementById('info').value = entry.info || '';
      document.getElementById('imageUrl').value = entry.imageUrl || '';
      document.getElementById('entryDate').value = entry.date || new Date().toISOString().split('T')[0];

      // Add wallet address fields
      if (entry.solanaAddresses && entry.solanaAddresses.length > 0) {
        entry.solanaAddresses.forEach(addr => addAddressWithValue('solana', addr));
      } else {
        addAddressField('solana');
      }
      
      if (entry.baseAddresses && entry.baseAddresses.length > 0) {
        entry.baseAddresses.forEach(addr => addAddressWithValue('base', addr));
      } else {
        addAddressField('base');
      }
      
      if (entry.polygonAddresses && entry.polygonAddresses.length > 0) {
        entry.polygonAddresses.forEach(addr => addAddressWithValue('polygon', addr));
      } else {
        addAddressField('polygon');
      }

      document.getElementById('entryModal').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('entryModal').style.display = 'none';
    }
    function openEditModal(index, isArchived) {
      if (isArchived) {
        const entry = archivedParticipants.find(p => p.id === index);
        if (!entry) return;

        document.getElementById('modalTitle').textContent = 'Edit Entry';
        document.getElementById('editId').value = index;
        
        // Populate form fields
        document.getElementById('participantName').value = entry.name || '';
        document.getElementById('telegram').value = entry.telegram || '';
        document.getElementById('twitter').value = entry.twitter || '';
        document.getElementById('discord').value = entry.discord || '';
        document.getElementById('email').value = entry.email || '';
        document.getElementById('status').value = entry.status || 'Manual';
        document.getElementById('info').value = entry.info || '';
        document.getElementById('imageUrl').value = entry.imageUrl || '';
        document.getElementById('entryDate').value = entry.date || new Date().toISOString().split('T')[0];

        // Clear and populate wallet fields
        document.getElementById('solanaAddressContainer').innerHTML = '';
        document.getElementById('baseAddressContainer').innerHTML = '';
        document.getElementById('polygonAddressContainer').innerHTML = '';

        if (entry.solanaAddresses?.length > 0) {
          entry.solanaAddresses.forEach(addr => addAddressWithValue('solana', addr));
        } else {
          addAddressField('solana');
        }
        
        if (entry.baseAddresses?.length > 0) {
          entry.baseAddresses.forEach(addr => addAddressWithValue('base', addr));
        } else {
          addAddressField('base');
        }
        
        if (entry.polygonAddresses?.length > 0) {
          entry.polygonAddresses.forEach(addr => addAddressWithValue('polygon', addr));
        } else {
          addAddressField('polygon');
        }

        document.getElementById('entryModal').style.display = 'block';
      } else {
        const entry = participants[index];
        if (!entry) return;

        document.getElementById('modalTitle').textContent = 'Edit Entry';
        document.getElementById('editId').value = index;
        
        // Populate form fields
        document.getElementById('participantName').value = entry.name || '';
        document.getElementById('telegram').value = entry.telegram || '';
        document.getElementById('twitter').value = entry.twitter || '';
        document.getElementById('discord').value = entry.discord || '';
        document.getElementById('email').value = entry.email || '';
        document.getElementById('status').value = entry.status || 'Manual';
        document.getElementById('info').value = entry.info || '';
        document.getElementById('imageUrl').value = entry.imageUrl || '';
        document.getElementById('entryDate').value = entry.date || new Date().toISOString().split('T')[0];

        // Clear and populate wallet fields
        document.getElementById('solanaAddressContainer').innerHTML = '';
        document.getElementById('baseAddressContainer').innerHTML = '';
        document.getElementById('polygonAddressContainer').innerHTML = '';

        if (entry.solanaAddresses?.length > 0) {
          entry.solanaAddresses.forEach(addr => addAddressWithValue('solana', addr));
        } else {
          addAddressField('solana');
        }
        
        if (entry.baseAddresses?.length > 0) {
          entry.baseAddresses.forEach(addr => addAddressWithValue('base', addr));
        } else {
          addAddressField('base');
        }
        
        if (entry.polygonAddresses?.length > 0) {
          entry.polygonAddresses.forEach(addr => addAddressWithValue('polygon', addr));
        } else {
          addAddressField('polygon');
        }

        document.getElementById('entryModal').style.display = 'block';
      }
    }
    </script>
    </body>
    </html>
